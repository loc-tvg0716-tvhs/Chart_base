<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lark Base – Radar Chart (Aggregate)</title>
  <style>
    html,body {height:100%;margin:0;font:14px system-ui;}
    #chart {width:100%;height:100%;}
    .panel {position:absolute;top:10px;left:10px;background:#fff;padding:10px;
            border:1px solid #ccc;border-radius:8px;z-index:10;max-width:300px;}
    label {display:block;margin-top:8px;font-size:13px;}
    select,input {width:100%;padding:6px;margin-top:4px;}
    button {margin-top:10px;padding:6px 10px;}
  </style>
</head>
<body>
  <div class="panel">
    <label>Category Field (Text/SingleSelect)</label>
    <select id="catField"></select>

    <label>Axis Fields (Number, chọn nhiều)</label>
    <select id="axisFields" multiple size="6"></select>

    <label>Aggregate</label>
    <select id="agg">
      <option value="avg">Average</option>
      <option value="sum">Sum</option>
      <option value="max">Max</option>
      <option value="min">Min</option>
      <option value="median">Median</option>
    </select>

    <button id="btnRender">Vẽ biểu đồ</button>
  </div>

  <div id="chart"></div>

  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <!-- Lark Base SDK -->
  <script type="module">
    import { bitable, FieldType } from "https://cdn.jsdelivr.net/npm/@lark-base-open/js-sdk@0.5.0/dist/index.mjs";

    const $ = id => document.getElementById(id);
    let chart = echarts.init($("chart"));

    async function init() {
      const table = await bitable.base.getActiveTable();
      const metas = await table.getFieldMetaList();

      // Category field options
      const catOptions = metas.filter(f => 
        [FieldType.Text, FieldType.SingleSelect].includes(f.type)
      );
      $("catField").innerHTML = catOptions.map(f => 
        `<option value="${f.id}">${f.name}</option>`).join("");

      // Axis field options (numbers)
      const numOptions = metas.filter(f => f.type === FieldType.Number);
      $("axisFields").innerHTML = numOptions.map(f => 
        `<option value="${f.id}">${f.name}</option>`).join("");

      $("btnRender").onclick = () => render(table);
    }

    function median(values) {
      if (!values.length) return 0;
      const sorted = [...values].sort((a,b)=>a-b);
      const mid = Math.floor(sorted.length/2);
      return sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid-1]+sorted[mid])/2;
    }

    async function render(table) {
      const catId = $("catField").value;
      const axisIds = Array.from($("axisFields").selectedOptions).map(o=>o.value);
      const agg = $("agg").value;

      if (!catId || axisIds.length===0) {
        alert("Chọn Category field và ít nhất 1 Axis field");
        return;
      }

      const catField = await table.getField(catId);
      const axisFields = await Promise.all(axisIds.map(id => table.getField(id)));
      const metas = await Promise.all(axisIds.map(id => table.getFieldMetaById(id)));
      const axisNames = metas.map(m=>m.name);

      // Lấy toàn bộ record ID
      const recs = await table.getRecordList();
      const groups = {};

      for (let r of recs) {
        const cat = (await catField.getValue(r.id)) || "(empty)";
        if (!groups[cat]) groups[cat] = [];

        const vals = [];
        for (let f of axisFields) {
          const v = await f.getValue(r.id);
          vals.push(Number(v)||0);
        }
        groups[cat].push(vals);
      }

      // Aggregate
      const series = [];
      for (let [cat, rows] of Object.entries(groups)) {
        const aggVals = [];
        for (let i=0;i<axisIds.length;i++) {
          const col = rows.map(r=>r[i]);
          let val=0;
          if (agg==="avg") val = col.reduce((a,b)=>a+b,0)/col.length;
          if (agg==="sum") val = col.reduce((a,b)=>a+b,0);
          if (agg==="max") val = Math.max(...col);
          if (agg==="min") val = Math.min(...col);
          if (agg==="median") val = median(col);
          aggVals.push(val);
        }
        series.push({name:cat,value:aggVals});
      }

      const indicators = axisNames.map(name=>({name, max:100}));
      chart.setOption({
        tooltip:{},
        legend:{top:0},
        radar:{indicator:indicators},
        series:[{type:"radar",data:series}]
      });
    }

    init();
  </script>
</body>
</html>
